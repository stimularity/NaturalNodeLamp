<!DOCTYPE html>
<html>
  <head>
	<title><%= title %></title>

	<link href="/stylesheets/jquery-ui-1.10.3.custom.min.css" rel="stylesheet">
	

	<link rel='stylesheet' href='/stylesheets/style.css' />
	<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet" />

	

  </head>
  <body>
<meta name="container" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=320, height=device-height, target-densitydpi=medium-dpi" />

	<div class="navbar navbar-inverse navbar-fixed-top">
	  <div class="navbar-inner">
		<div class="container">
		  <button type="button" class="btn btn-navbar">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		  </button>
		  <a class="brand" href="#"><%= title %></a>

			<ul class="nav">
			  <li class="active"><a href="#"><i class="icon-time icon-white"></i> <span id="servertime"></span></a></li>
			  <li><a href="#about">About</a></li>
			</ul>

		</div>
	  </div>
	</div>

	<div class="container" name> <!-- /container -->
		<div class="btn-group">
		<button class="btn button" id="on">on</button>
		<button class="btn button" id="off">off</button>
	</div>

	<button class="btn" id="newalarm"><i class="icon-plus"></i> New Alarm</button>
		<br />
		<br />

		<!-- Graphical Interface items collected from /graphical -->
		<div id="graphical"></div><!-- /graphical -->

		<br />

		<div id="alarms"></div><!-- /alarms -->

	</div> <!-- /container -->

	
	
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
	<script src="/javascripts/jquery-ui-1.10.3.custom.min.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script>


	var d = new Date();
	var mh = d.getHours(); //0 - 23
	var m = d.getMinutes(); //0 - 59

	//console.log('mh:' + mh + ' m: ' + m);

	var socket = io.connect();
	socket.emit('getAlarms');

	socket.on('servertime', function(data){
		$('#servertime').empty().append(data['servertime']);
	});

	socket.on('refreshAlarms', function(a){
		$.get('/alarms', function(data){ //Get /alarms from server
			$('#alarms').empty().append(data); //Empty current alarms box

			$('#alarms div .btn').unbind().click(function(){ //Unbind all values then 
				var field = $(this).attr('title'); //DB row name
				var id = $(this).parent().parent('.row-fluid').attr('id'); //Id in DB
				//Toggle value
				var value = 0 //Value we want to set in DB
				if($(this).attr('value') == 0){ value = 1; }

				//Send to server -> Directly into DB!
				socket.emit('updateAlarm', id, field, value); //Send choice to server
				$(this).addClass('btn-primary'); 
			});

			//Bind events to all the shit here.
			$('.deletebutton').unbind().click(function(){
				var id = $(this).parent('.row-fluid').attr('id');
				console.log('Delete ' + id);
				socket.emit('deleteAlarm', id); //Does not refresh alarms
				$(this).parent('.row-fluid').fadeOut(250);
			});

			$('.icon-bell').click(function(){
				var id = 2; //todo get row id, post to view 
			});
		});//-get end
		

		

	});

	$(document).ready(function() {
		
		$.get('/graphical', function(data){
			$('#graphical').empty().append(data); //Empty Box and append button data
			activateButtons(); //Bind actions to buttons
			$('.controlpannel').hide();
			$('#home').fadeIn(1000);

			//Activate tab and display proper pannel.
			$('#guitabs li').click(function(){
				$('#guitabs li').removeClass('active');
				area = $(this).text();
				$('.controlpannel').hide(); //Hide other pannels
				$('#'+area).fadeIn(500);
				$(this).addClass('active');
			});
			
		});

	});//

	function activateButtons(){
		$( ".slider" ).unbind().slider({ max:255, min:0,
		slide: function( event, ui ) {
			value = $(this).slider('value');
			id = $(this).attr('id');
			//console.log(id + ": " + value);
			socket.emit('interact', { id:id, value:value });
		}
		});

		$(".button").unbind().click(function(){
			id = $(this).attr('id');
			//console.log("Pressed: " + id);
			socket.emit('interact', { id:id, value:1 });
		});

		$('#newalarm').unbind().click(function(){
			$.get('/alarmentry', function(data){
				lightBox(500, 0, data);
			});
		});
	}

	//Max's custom animated lightbox plugin. Quite magical.
	function lightBox(w, h, content) {
		$('#lightbox, #lightboxcore').remove(); //Destroy old lightboxes. There can only be one.
		$('body').prepend('<div id="lightboxcore">'+content+'</div>'); //Append inner box

		//Default values if none are set.
		marginsize = 200;
		width = $(window).width() - marginsize; 
		height = $(window).height() - marginsize;

		if(w != 0 && h == 0){ //Width is set, but not height, get height from content.	
			height = $('#lightboxcore').height(); //Get Height of box used for centering, height is set dynamically.
			width = w;
		}
		if(w == 0 && h != 0){ //Width is set, use default height. 
			height = h;
		}
		if(w != 0 && h != 0){ //Use user inputs. 
			width = w;
			height = h;
		}
		
		$('#lightboxcore').css({'width': width, 'height':height}); //Set width of lightboxcore

		//Add backdrop to DOm
		$('html').prepend('<div id="lightbox"></div>').fadeIn(400); 
		$('#lightbox').css({'height': $(document).height(), 'width': $(document).width()}); //Set proper size
		$("#lightbox").click(function() {
			closeLightbox(); //Bind close event to backdrop
		});
		//Center the core on page
		$('#lightboxcore').css("top", (($(window).height() - $('#lightboxcore').outerHeight()) / 2) + $(window).scrollTop() + "px");
		$('#lightboxcore').css("left", (($(window).width() - $('#lightboxcore').outerWidth()) / 2) + $(window).scrollLeft() + "px");
		//Make it visible. 
		$('#lightboxcore').hide().fadeIn(500);
	}
	function closeLightbox(){
		$('#lightbox').fadeOut(500);
		$('#lightboxcore').fadeOut(300);
	}


</script>
  </body>
</html>